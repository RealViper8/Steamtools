name: Release

on:
  push:
    branches:
        - main

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build
        run: cargo build --release
      
      - name: Restore Cert
        shell: powershell
        run: |
          [IO.File]::WriteAllBytes(
            "codesign.pfx",
            [Convert]::FromBase64String("${{ secrets.WIN_CERT_PFX_BASE64 }}")
          )

      - name: Add signtool to PATH
        shell: powershell
        run: |
          $sdk = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" |
            Sort-Object Name -Descending |
            Select-Object -First 1

          echo "$($sdk.FullName)\x64" >> $env:GITHUB_PATH
      
      - name: Sign exe
        shell: powershell
        run: |
          signtool sign /f devcodesign.pfx /p "Viper67811" /fd SHA256 /t "http://timestamp.digicert.com" target\release\stcli.exe
      
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: target\release\stcli.exe
